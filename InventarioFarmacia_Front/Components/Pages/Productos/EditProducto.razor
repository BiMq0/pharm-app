@page "/productos/editar/{id:int}"
@using InventarioFarmacia_Front.Services.Products
@using InventarioFarmacia_Shared.DTOs.Products;
@using InventarioFarmacia_Shared.DTOs.Categorias;
@using InventarioFarmacia_Front.Components.SimpleComponents.Modals;
@inject Services.Products.IProductoService ProductServices
@inject Services.Categories.ICategoriaService CategoriaService
@inject IWebHostEnvironment Environment
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Editar Producto</PageTitle>

<div class="container-fluid mt-3">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex align-items-center mb-3">
                <div class="card bg-primary p-4 text-white rounded-3 shadow w-100">
                    <h1 class="fw-bold mb-1"><i class="bi bi-box-fill"></i> Editar Producto</h1>
                    <p class="opacity-75 mb-0">Modifica los datos del producto en el inventario de la farmacia</p>
                </div>
            </div>
        </div>
    </div>
    <div class="row w-100">
        <div class="col-lg-12 col-xl-12">
            <div class="card shadow border-0">
                <div class="card-header bg-primary bg-gradient text-white">
                    <h5 class="card-title mb-0 fw-bold"><i class="bi bi-pencil-fill"></i> Información del Producto</h5>
                </div>
                <div class="card-body p-4">
                    <EditForm Model="@ProductoEdicion" OnValidSubmit="EditarProducto" FormName="AgregarProductoForm">
                        <DataAnnotationsValidator />

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-4">
                                    <label for="nombre" class="form-label fw-semibold">
                                        Nombre del Producto <span class="text-danger">*</span>
                                    </label>
                                    <InputText id="nombre" class="form-control form-control-lg"
                                        @bind-Value="ProductoEdicion.Nombre"
                                        placeholder="Ej: Paracetamol, Ibuprofeno, etc." />
                                    <ValidationMessage For="@(() => ProductoEdicion.Nombre)"
                                        class="text-danger small" />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-4">
                                    <label for="nombreClinico" class="form-label fw-semibold">
                                        Nombre Clínico <span class="text-danger">*</span>
                                    </label>
                                    <InputText id="nombreClinico" class="form-control form-control-lg"
                                        @bind-Value="ProductoEdicion.Nombre_Clinico"
                                        placeholder="Nombre científico o genérico" />
                                    <ValidationMessage For="@(() => ProductoEdicion.Nombre_Clinico)"
                                        class="text-danger small" />
                                    <div class="form-text">Nombre científico o principio activo</div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <h6 class="fw-bold text-primary border-bottom pb-2 mb-3"><i
                                    class="bi bi-currency-dollar"></i> Información de Precios</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="precio" class="form-label fw-semibold">
                                        Precio por Unidad <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group input-group-lg">
                                        <span class="input-group-text">Bs.</span>
                                        <InputNumber id="precio" class="form-control"
                                            @bind-Value="ProductoEdicion.Precio_Unitario" placeholder="0.00" />
                                    </div>
                                    <ValidationMessage For="@(() => ProductoEdicion.Precio_Unitario)"
                                        class="text-danger small" />
                                </div>
                                <div class="col-md-6">
                                    <label for="precio_Caja" class="form-label fw-semibold">
                                        Precio por Caja
                                    </label>
                                    <div class="input-group input-group-lg">
                                        <span class="input-group-text">Bs.</span>
                                        <InputNumber id="precio_Caja" class="form-control"
                                            @bind-Value="ProductoEdicion.Precio_Caja" placeholder="0.00" />
                                    </div>
                                    <ValidationMessage For="@(() => ProductoEdicion.Precio_Caja)"
                                        class="text-danger small" />
                                    <div class="form-text">Precio opcional para venta por caja</div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <h6 class="fw-bold text-primary border-bottom pb-2 mb-3"><i class="bi bi-box-fill"></i>
                                Información de Inventario</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="existencias_por_caja" class="form-label fw-semibold">
                                        Existencias por Caja
                                    </label>
                                    <InputNumber id="existencias_por_caja" class="form-control form-control-lg"
                                        @bind-Value="ProductoEdicion.Existencias_Por_Caja"
                                        placeholder="Ej: 10, 20, 50..." />
                                    <ValidationMessage For="@(() => ProductoEdicion.Existencias_Por_Caja)"
                                        class="text-danger small" />
                                    <div class="form-text">Cantidad de unidades que contiene una caja</div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">
                                            Configuración de Subunidades
                                        </label>
                                        <div class="form-check form-switch">
                                            <InputCheckbox id="tiene_subunidades" class="form-check-input"
                                                @bind-Value="ProductoEdicion.Tiene_Subunidades" />
                                            <label class="form-check-label" for="tiene_subunidades">
                                                ¿Tiene Subunidades? <span class="text-muted">(Ej: Pastillas,
                                                    Cápsulas)</span>
                                            </label>
                                        </div>
                                    </div>

                                    @if (ProductoEdicion?.Tiene_Subunidades == true)
                                    {
                                        <div class="mt-3">
                                            <label for="subunidades" class="form-label fw-semibold">
                                                Unidades por Existencia <span class="text-danger">*</span>
                                            </label>
                                            <InputNumber id="subunidades" class="form-control form-control-lg"
                                                @bind-Value="ProductoEdicion.Unidades_Por_Existencia"
                                                placeholder="Ej: 10 pastillas por blister" />
                                            @if (ProductoEdicion?.Unidades_Por_Existencia is null ||
                                                                                    ProductoEdicion.Unidades_Por_Existencia <= 0)
                                            {
                                                <div class="text-danger small mt-1">Debe ingresar una cantidad válida de
                                                    subunidades.</div>
                                            }
                                            <div class="form-text">Cantidad de subunidades por presentación</div>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>


                        <div class="mb-4">
                            <h6 class="fw-bold text-primary border-bottom pb-2 mb-3"><i class="bi bi-tag-fill"></i>
                                Categorización</h6>
                            <label for="categoria" class="form-label fw-semibold">
                                Categoría del Producto <span class="text-danger">*</span>
                            </label>
                            <InputSelect id="categoria" class="form-select form-select-lg"
                                @bind-Value="categoriaSeleccionada" @onchange="OnCategoriaChanged">
                                <option value="">Seleccione una categoría</option>
                                @foreach (var categoria in categorias)
                                {
                                    <option value="@categoria.Nombre">@categoria.Nombre</option>
                                }
                            </InputSelect>
                            @if (string.IsNullOrEmpty(categoriaSeleccionada))
                            {
                                <div class="text-danger small mt-1">Debe seleccionar una categoría.</div>
                            }
                            else
                            {
                                <div class="text-success small mt-1">✓ Categoría seleccionada: @categoriaSeleccionada</div>
                            }
                        </div>

                        <div class="mb-4">
                            <h6 class="fw-bold text-primary border-bottom pb-2 mb-3">Imagen del Producto</h6>
                            <label for="imagen" class="form-label fw-semibold">
                                Imagen del Producto <span class="text-danger">*</span>
                            </label>

                            @if (!string.IsNullOrEmpty(ProductoEdicion?.Ruta_Imagen))
                            {
                                <div class="text-success small mt-1"><i class="bi bi-file-earmark-image"></i> Archivo
                                    seleccionado:
                                    @System.IO.Path.GetFileName(ProductoEdicion.Ruta_Imagen)</div>
                            }

                            @if (!string.IsNullOrEmpty(imagePreviewUrl))
                            {
                                <div class="mt-3">
                                    <label class="form-label fw-semibold text-muted">Vista Previa:</label>
                                    <div class="text-center p-3 border rounded bg-light">
                                        <img src="@imagePreviewUrl" alt="Vista previa del producto"
                                            class="img-fluid rounded shadow"
                                            style="max-width: 250px; max-height: 250px; object-fit: cover;" />
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="mt-3">
                                    <div class="text-center p-4 border rounded bg-light text-muted">
                                        <i class="bi bi-image" style="font-size: 3rem;"></i>
                                        <p class="mb-0 mt-2">Sin imagen seleccionada</p>
                                        <small>Seleccione una imagen para ver la vista previa</small>
                                    </div>
                                </div>
                            }
                            <div class="form-text">Formatos soportados: JPG, PNG, GIF (máximo 5MB)</div>
                        </div>

                        <div class="d-flex gap-3 justify-content-between mt-5">
                            <button type="button" class="btn btn-outline-secondary me-3" @onclick="RegresarAProductos">
                                <i class="bi bi-arrow-left"></i> Regresar
                            </button>
                            <div>
                                <button type="button" class="btn btn-outline-danger px-4"
                                    @onclick="MostrarModalSolicitudConfirmacion">
                                    <i class="bi bi-trash"></i> Eliminar Producto
                                </button>
                                <button type="submit" class="btn btn-primary px-4 fw-semibold ms-2">
                                    <i class="bi bi-pencil-fill"></i> Actualizar Producto
                                </button>
                            </div>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
</div>


@* Modal de confirmación *@
@if (MostrarModal)
{
    @if (RegistroExitoso)
    {
        <ModalMensaje Titulo="¡Éxito!" OnAceptar="CerrarModalYRegresar" Exito="true" />
    }
    else
    {
        <ModalMensaje Titulo="Error" OnAceptar="CerrarModal" Exito="false" />
    }
}

@if (MostrarModalConfirmacion)
{
    <ModalConfirmacion OnAceptar="@(() => EliminarProducto(id))" OnCancelar="CerrarModal" />
}

@code {
    [SupplyParameterFromForm]
    private ProductoEdicionDTO ProductoEdicion { get; set; } = new();
    [Parameter]
    public int id { get; set; }
    private string imagePreviewUrl = string.Empty;
    private string categoriaSeleccionada = string.Empty;
    private int idCategoriaSeleccionada = -1;
    private IEnumerable<CategoriaToNewProductoDTO> categorias = new List<CategoriaToNewProductoDTO>();

    private bool RegistroExitoso { get; set; } = false;
    private bool MostrarModal { get; set; } = false;
    private bool MostrarModalConfirmacion { get; set; } = false;
    protected override async Task OnInitializedAsync()
    {
        ProductoEdicion = await ProductServices.GetProductoPorIdForEditAsync(id);
        imagePreviewUrl = ProductoEdicion.Ruta_Imagen;
        categorias = await CategoriaService.GetCategoriasParaNuevoProductoAsync();
        categoriaSeleccionada = ProductoEdicion.Categoria.Nombre;
        idCategoriaSeleccionada = ProductoEdicion.Categoria.Id;
        StateHasChanged();
    }

    private void OnCategoriaChanged(ChangeEventArgs e)
    {
        categoriaSeleccionada = e.Value?.ToString() ?? string.Empty;

        if (ProductoEdicion?.Categoria != null)
        {
            ProductoEdicion.Categoria.Nombre = categoriaSeleccionada;
        }

        StateHasChanged();
    }

    private async Task EditarProducto()
    {
        try
        {
            if (string.IsNullOrEmpty(categoriaSeleccionada))
            {
                Console.WriteLine("Error: Debe seleccionar una categoría");
                RegistroExitoso = false;
                MostrarModal = true;
                return;
            }

            if (string.IsNullOrEmpty(ProductoEdicion?.Ruta_Imagen))
            {
                Console.WriteLine("Error: Debe seleccionar una imagen");
                RegistroExitoso = false;
                MostrarModal = true;
                return;
            }

            if (ProductoEdicion?.Categoria != null)
            {
                ProductoEdicion.Categoria.Nombre = categoriaSeleccionada;
            }

            await Task.Delay(100);
            var resultado = await ProductServices.EditarProducto(ProductoEdicion!);
            RegistroExitoso = resultado;
            MostrarModal = true;
        }
        catch (Exception ex)
        {
            RegistroExitoso = false;
            MostrarModal = true;
            Console.WriteLine($"Error: {ex.Message}");
        }

        StateHasChanged();
    }

    private void CerrarModal()
    {
        MostrarModal = false;
        MostrarModalConfirmacion = false;
        StateHasChanged();
    }

    private void CerrarModalYRegresar()
    {
        MostrarModal = false;
        if (RegistroExitoso)
        {
            Navigation.NavigateTo("/productos");
        }
        StateHasChanged();
    }

    private void RegresarAProductos()
    {
        Navigation.NavigateTo("/productos");
    }
    private void MostrarModalSolicitudConfirmacion()
    {
        MostrarModalConfirmacion = true;
        StateHasChanged();
    }
    private async void EliminarProducto(int id)
    {
        MostrarModalConfirmacion = false;
        var eliminacion = await ProductServices.EliminarProducto(id);
        if (eliminacion)
        {
            RegistroExitoso = true;
        }
        else
        {
            RegistroExitoso = false;
        }
        MostrarModal = true;
        StateHasChanged();
    }
}
