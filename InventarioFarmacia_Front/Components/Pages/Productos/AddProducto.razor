@page "/productos/agregar"
@using InventarioFarmacia_Shared.DTOs.Products;
@using InventarioFarmacia_Shared.DTOs.Categorias;
@using InventarioFarmacia_Front.Components.SimpleComponents.Modals;
@inject Services.Products.IProductoService ProductServices
@inject Services.Categories.ICategoriaService CategoriaService
@inject IWebHostEnvironment Environment
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Agregar Producto</PageTitle>

<div class="container-fluid mt-3">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex align-items-center mb-3">
                <div class="card bg-primary p-4 text-white rounded-3 shadow w-100">
                    <h1 class="fw-bold mb-1"><i class="bi bi-box-fill"></i> Nuevo Producto</h1>
                    <p class="opacity-75 mb-0">Agrega un nuevo producto al inventario de la farmacia</p>
                </div>
            </div>
        </div>
    </div>
    <div class="row w-100">
        <div class="col-lg-12 col-xl-12">
            <div class="card shadow border-0">
                <div class="card-header bg-primary bg-gradient text-white">
                    <h5 class="card-title mb-0 fw-bold"><i class="bi bi-pencil-fill"></i> Información del Producto</h5>
                </div>
                <div class="card-body p-4">
                    <EditForm Model="@ProductoNuevo" OnValidSubmit="AgregarProducto" FormName="AgregarProductoForm">
                        <DataAnnotationsValidator />

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-4">
                                    <label for="nombre" class="form-label fw-semibold">
                                        Nombre del Producto <span class="text-danger">*</span>
                                    </label>
                                    <InputText id="nombre" class="form-control form-control-lg"
                                        @bind-Value="ProductoNuevo.Nombre"
                                        placeholder="Ej: Paracetamol, Ibuprofeno, etc." />
                                    <ValidationMessage For="@(() => ProductoNuevo.Nombre)" class="text-danger small" />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-4">
                                    <label for="nombreClinico" class="form-label fw-semibold">
                                        Nombre Clínico <span class="text-danger">*</span>
                                    </label>
                                    <InputText id="nombreClinico" class="form-control form-control-lg"
                                        @bind-Value="ProductoNuevo.Nombre_Clinico"
                                        placeholder="Nombre científico o genérico" />
                                    <ValidationMessage For="@(() => ProductoNuevo.Nombre_Clinico)"
                                        class="text-danger small" />
                                    <div class="form-text">Nombre científico o principio activo</div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <h6 class="fw-bold text-primary border-bottom pb-2 mb-3"><i
                                    class="bi bi-currency-dollar"></i> Información de Precios</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="precio" class="form-label fw-semibold">
                                        Precio por Unidad <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group input-group-lg">
                                        <span class="input-group-text">Bs.</span>
                                        <InputNumber id="precio" class="form-control"
                                            @bind-Value="ProductoNuevo.Precio_Unitario" placeholder="0.00" />
                                    </div>
                                    <ValidationMessage For="@(() => ProductoNuevo.Precio_Unitario)"
                                        class="text-danger small" />
                                </div>
                                <div class="col-md-6">
                                    <label for="precio_Caja" class="form-label fw-semibold">
                                        Precio por Caja
                                    </label>
                                    <div class="input-group input-group-lg">
                                        <span class="input-group-text">Bs.</span>
                                        <InputNumber id="precio_Caja" class="form-control"
                                            @bind-Value="ProductoNuevo.Precio_Caja" placeholder="0.00" />
                                    </div>
                                    <ValidationMessage For="@(() => ProductoNuevo.Precio_Caja)"
                                        class="text-danger small" />
                                    <div class="form-text">Precio opcional para venta por caja</div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <h6 class="fw-bold text-primary border-bottom pb-2 mb-3"><i class="bi bi-box-fill"></i>
                                Información de Inventario</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="existencias_por_caja" class="form-label fw-semibold">
                                        Existencias por Caja
                                    </label>
                                    <InputNumber id="existencias_por_caja" class="form-control form-control-lg"
                                        @bind-Value="ProductoNuevo.Existencias_Por_Caja"
                                        placeholder="Ej: 10, 20, 50..." />
                                    <ValidationMessage For="@(() => ProductoNuevo.Existencias_Por_Caja)"
                                        class="text-danger small" />
                                    <div class="form-text">Cantidad de unidades que contiene una caja</div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">
                                            Configuración de Subunidades
                                        </label>
                                        <div class="form-check form-switch">
                                            <InputCheckbox id="tiene_subunidades" class="form-check-input"
                                                @bind-Value="ProductoNuevo.Tiene_Subunidades" />
                                            <label class="form-check-label" for="tiene_subunidades">
                                                ¿Tiene Subunidades? <span class="text-muted">(Ej: Pastillas,
                                                    Cápsulas)</span>
                                            </label>
                                        </div>
                                    </div>

                                    @if (ProductoNuevo?.Tiene_Subunidades == true)
                                    {
                                        <div class="mt-3">
                                            <label for="subunidades" class="form-label fw-semibold">
                                                Unidades por Existencia <span class="text-danger">*</span>
                                            </label>
                                            <InputNumber id="subunidades" class="form-control form-control-lg"
                                                @bind-Value="ProductoNuevo.Unidades_Por_Existencia"
                                                placeholder="Ej: 10 pastillas por tableta" />
                                            @if (ProductoNuevo?.Unidades_Por_Existencia is null ||
                                                                                    ProductoNuevo.Unidades_Por_Existencia <= 0)
                                            {
                                                <div class="text-danger small mt-1">Debe ingresar una cantidad válida de
                                                    subunidades.</div>
                                            }
                                            <div class="form-text">Cantidad de subunidades por presentación</div>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <h6 class="fw-bold text-primary border-bottom pb-2 mb-3"><i class="bi bi-tag-fill"></i>
                                Categorización</h6>
                            <label for="categoria" class="form-label fw-semibold">
                                Categoría del Producto <span class="text-danger">*</span>
                            </label>
                            <InputSelect id="categoria" class="form-select form-select-lg"
                                @bind-Value="idCategoriaSeleccionada" @bind-Value:after="OnCategoriaChanged">
                                <option value="-1">Seleccione una categoría</option>
                                @foreach (var categoria in categorias)
                                {
                                    <option value="@categoria.Id">@categoria.Nombre</option>
                                }
                            </InputSelect>
                            @if (idCategoriaSeleccionada == -1)
                            {
                                <div class="text-danger small mt-1">Debe seleccionar una categoría.</div>
                            }
                            else
                            {
                                <div class="text-success small mt-1"><i class="bi bi-check-circle-fill"></i>
                                    Categoría seleccionada: @categoriaSeleccionada</div>
                            }
                        </div>
                        <div class="mb-4">
                            <h6 class="fw-bold text-primary border-bottom pb-2 mb-3"><i class="bi bi-camera-fill"></i>
                                Imagen del Producto</h6>
                            <label for="imagen" class="form-label fw-semibold">
                                Imagen del Producto <span class="text-danger">*</span>
                            </label>
                            <InputFile id="imagen" class="form-control form-control-lg" OnChange="OnImageSelected"
                                accept="image/*" />

                            @if (string.IsNullOrEmpty(ProductoNuevo?.Ruta_Imagen))
                            {
                                <div class="text-danger small mt-1">Debe seleccionar una imagen.</div>
                            }

                            @if (!string.IsNullOrEmpty(ProductoNuevo?.Ruta_Imagen))
                            {
                                <div class="text-success small mt-1"><i class="bi bi-check-circle-fill"></i>
                                    Archivo seleccionado: @System.IO.Path.GetFileName(ProductoNuevo.Ruta_Imagen)</div>
                            }

                            @if (!string.IsNullOrEmpty(imagePreviewUrl))
                            {
                                <div class="mt-3">
                                    <label class="form-label fw-semibold text-muted">Vista Previa:</label>
                                    <div class="text-center p-3 border rounded bg-light">
                                        <img src="@imagePreviewUrl" alt="Vista previa del producto"
                                            class="img-fluid rounded shadow"
                                            style="max-width: 250px; max-height: 250px; object-fit: cover;" />
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="mt-3">
                                    <div class="text-center p-4 border rounded bg-light text-muted">
                                        <i class="bi bi-image" style="font-size: 3rem;"></i>
                                        <p class="mb-0 mt-2">Sin imagen seleccionada</p>
                                        <small>Seleccione una imagen para ver la vista previa</small>
                                    </div>
                                </div>
                            }
                            <div class="form-text">Formatos soportados: JPG, PNG, GIF (máximo 5MB)</div>
                        </div>

                        <div class="d-flex gap-3 justify-content-between mt-5">
                            <button type="button" class="btn btn-outline-secondary me-3" @onclick="RegresarAProductos">
                                ← Regresar
                            </button>
                            <div>
                                <button type="button" class="btn btn-outline-danger px-4" @onclick="LimpiarFormulario">
                                    Limpiar
                                </button>
                                <button type="submit" class="btn btn-primary px-4 fw-semibold ms-2">
                                    <i class="bi bi-plus-circle"></i> Crear Producto
                                </button>
                            </div>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
</div>


@* Modal de confirmación *@
@if (MostrarModal)
{
    @if (RegistroExitoso)
    {
        <ModalMensaje Titulo="¡Éxito!" OnAceptar="CerrarModalYRegresar" Exito="true" />
    }
    else
    {
        <ModalMensaje Titulo="Error" OnAceptar="CerrarModal" Exito="false" />
    }
}

@code {
    [SupplyParameterFromForm]
    private ProductoNuevoDTO ProductoNuevo { get; set; } = new();
    private bool RegistroExitoso { get; set; } = false;
    private bool MostrarModal { get; set; } = false;

    private string imagePreviewUrl = string.Empty;
    private const long MaxFileSize = 5 * 1024 * 1024;
    private IEnumerable<CategoriaToNewProductoDTO> categorias = new List<CategoriaToNewProductoDTO>();

    private string categoriaSeleccionada = string.Empty;
    private int idCategoriaSeleccionada = -1;

    protected override async Task OnInitializedAsync()
    {
        if (ProductoNuevo == null)
        {
            ProductoNuevo = new ProductoNuevoDTO();
        }
        categorias = await CategoriaService.GetCategoriasParaNuevoProductoAsync();

        await Task.CompletedTask;
        StateHasChanged();
    }

    private void OnCategoriaChanged()
    {
        if (idCategoriaSeleccionada > 0)
        {
            var categoria = categorias.FirstOrDefault(c => c.Id == idCategoriaSeleccionada);
            categoriaSeleccionada = categoria.Nombre;
            ProductoNuevo.Id_Categoria = categoria.Id;
        }
        else
        {
            categoriaSeleccionada = string.Empty;
            if (ProductoNuevo?.Id_Categoria != null)
            {
                ProductoNuevo.Id_Categoria = -1;
            }
        }

        StateHasChanged();
    }

    private async Task OnImageSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file != null)
        {
            if (file.Size > MaxFileSize)
            {
                Console.WriteLine("El archivo es demasiado grande. Máximo 5MB.");
                return;
            }
            if (!file.ContentType.StartsWith("image/"))
            {
                Console.WriteLine("Solo se permiten archivos de imagen.");
                return;
            }
            try
            {
                var uploadsPath = Path.Combine(Environment.WebRootPath, "uploads", "productos");
                if (!Directory.Exists(uploadsPath))
                {
                    Directory.CreateDirectory(uploadsPath);
                }

                // Generar nombre único para el archivo
                var fileName = $"{Guid.NewGuid()}_{file.Name}";
                var filePath = Path.Combine(uploadsPath, fileName);

                // Guardar el archivo
                using var stream = file.OpenReadStream(MaxFileSize);
                using var fileStream = new FileStream(filePath, FileMode.Create);
                await stream.CopyToAsync(fileStream);

                ProductoNuevo.Ruta_Imagen = $"/uploads/productos/{fileName}";
                imagePreviewUrl = ProductoNuevo.Ruta_Imagen;

                StateHasChanged();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error al guardar la imagen: {ex.Message}");
            }
        }
    }

    private async Task AgregarProducto()
    {
        try
        {
            if (idCategoriaSeleccionada <= 0)
            {
                Console.WriteLine("Error: Debe seleccionar una categoría");
                RegistroExitoso = false;
                MostrarModal = true;
                return;
            }
            if (string.IsNullOrEmpty(ProductoNuevo?.Ruta_Imagen))
            {
                RegistroExitoso = false;
                MostrarModal = true;
                StateHasChanged();
                return;
            }

            await Task.Delay(100);
            var resultado = await ProductServices.CrearProducto(ProductoNuevo!);
            RegistroExitoso = resultado;
            MostrarModal = true;
        }
        catch (Exception ex)
        {
            RegistroExitoso = false;
            MostrarModal = true;
            Console.WriteLine($"Error: {ex.Message}");
        }

        StateHasChanged();
    }

    private void CerrarModal()
    {
        MostrarModal = false;
        StateHasChanged();
    }

    private void CerrarModalYRegresar()
    {
        MostrarModal = false;
        if (RegistroExitoso)
        {
            LimpiarFormulario();
            Navigation.NavigateTo("/productos");
        }
        StateHasChanged();
    }

    private void RegresarAProductos()
    {
        Navigation.NavigateTo("/productos");
    }

    private void LimpiarFormulario()
    {
        ProductoNuevo = new ProductoNuevoDTO();
        ProductoNuevo.Id_Categoria = 0;
        idCategoriaSeleccionada = -1;
        categoriaSeleccionada = string.Empty;
        imagePreviewUrl = string.Empty;
        StateHasChanged();
    }
}
